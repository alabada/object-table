/**
 * qs-table - angular smart table directive
 * @version v0.2.2
 * @author Yauheni Kokatau
 * @license MIT
 */
"use strict";angular.module("qsTable",[]).directive("contenteditable",function(){return{restrict:"A",require:["ngModel","^qsTable"],link:function(e,t,n,r){var i=r[0],a=r[1];i.$render=function(){t.html(i.$viewValue||"")},t.bind("change blur",function(){if(null!=i.$viewValue)var n=i.$viewValue.toString();else var n="";var r=t.text();n!==r&&(e.$apply(function(){i.$setViewValue(r)}),a.onEdit&&"function"==typeof a.onEdit&&a.onEdit({$oldValue:n,$newValue:r}))})}}}),angular.module("qsTable").directive("allowDrag",function(){return{restrict:"A",controller:function(){},compile:function(e,t){function n(e,t){var n=e[0].parentNode.querySelector("."+t);n&&n.classList.remove(t)}return function(e,t,r,i){t.attr("draggable",!0),t.bind("dragstart",function(e){i.target=this,this.classList.add("dragged");var t=e.originalEvent||e;t.dataTransfer.setData("text",i.target.cellIndex)}),t.bind("dragend",function(e){this.classList.contains("dragged")&&this.classList.remove("dragged"),e.preventDefault()}),t.bind("dragover",function(e){e.preventDefault()}),t.bind("dragenter",function(e){i.toTarget=this,this.classList.contains("draggedOver")||this.classList.contains("dragged")||this.classList.add("draggedOver"),e.preventDefault(),e.stopPropagation()}),t.bind("dragleave",function(e){this.classList.remove("draggedOver")}),t.bind("drop",function(e){var r=i.toTarget.cellIndex,a=e.originalEvent||e,d=parseInt(a.dataTransfer.getData("text"),10);n(t,"dragged"),n(t,"draggedOver"),t.parent().controller("qsTable").changeColumnsOrder(r,d),e.preventDefault()})}}}}),angular.module("qsTable").controller("QsTableCtrl",["$scope","$timeout","$element","$attrs","$http","$compile","$controller","QsTableUtilService",function(e,t,n,r,i,a,d,l){d("QsTableSortingCtrl",{$scope:e}),d("QsTableResizeCtrl",{$scope:e});var c=this,o=!0;this._init=function(){e.headers=[],e.fields=[],e.itemsPerPage=e.itemsPerPage||5,e.paging=!angular.isDefined(e.paging)||e.paging,e.sortingType=e.sortingType||"simple",e.currentPage=1,e.customHeader=!1,e.pageGroup=["10","20","50"],"separate"==r.search?(e.search="separate",e.columnSearch=[]):e.search="undefined"!=typeof r.search&&"true"===r.search,e.headers=l.getArrayFromParams(r.headers,"headers"),e.fields=l.getArrayFromParams(r.fields,"fields"),r.fromUrl&&this._loadExternalData(r.fromUrl),e.onEdit&&(this.onEdit=e.onEdit),e.selectedModel="multiply"===e.select?[]:{}},this.onEdit=e.onEdit,this._loadExternalData=function(t){e.dataIsLoading=!0,i.get(t).then(function(t){e.data=t.data,e.dataIsLoading=!1})},this.changeColumnsOrder=function(t,r){var i=t,d=r,l=t,s=r;"multiply"===e.select&&(e.findHead||e.findBody?e.findHead&&!e.findBody?(l-=1,s-=1):!e.findHead&&e.findBody?(i-=1,d-=1):e.findHead&&e.findBody:(i-=1,d-=1,l-=1,s-=1)),e.$apply(function(){e.fields.swap(l,s);var t=e.headers.slice();if(e.headers.swap(i,d),e.onDrag&&"function"==typeof e.onDrag&&e.onDrag({$oldOrder:t,$newOrder:e.headers}),t=null,e.columnSearch&&e.columnSearch.swap(i,d),c.bodyTemplate){var r=angular.element(c.bodyTemplate).children(),u=document.createElement("tr"),f=document.createElement("tbody"),h=n.find("tbody").find("tr")[0].attributes;if([].forEach.call(h,function(e,t){u.setAttribute(e.name,e.value)}),"multiply"===e.select&&!0===o){o=!1;var p=document.createElement("td"),g=document.createElement("input");g.setAttribute("type","checkbox"),g.setAttribute("ng-checked","isSelected(item)"),angular.element(p).append(g),u.appendChild(p),Array.prototype.swap.apply(r,[l-1,s-1])}else Array.prototype.swap.apply(r,[l,s]);for(var m=0,b=r.length;m<b;m++)u.appendChild(r[m]);f.appendChild(u),n.find("tbody").replaceWith(f),c.bodyTemplate=f.innerHTML,a(n.find("tbody"))(e)}if(e.customHeader){var y=n.find("th"),u=document.createElement("tr"),v=document.createElement("thead");Array.prototype.swap.apply(y,[i,d]);for(var m=0,b=y.length;m<b;m++)u.appendChild(y[m]);v.appendChild(u),n.find("thead").replaceWith(v)}e.jumpToPage(1)})},this._addHeaderPattern=function(t){if(e.customHeader=!0,Array.prototype.forEach.call(t.querySelectorAll("[allow-drag]"),function(e,t){e.setAttribute("index",t)}),t.removeAttribute("ng-non-bindable"),n.find("table").prepend(t),"multiply"===e.select){if("undefined"!=typeof n.find("thead").children()[0]){var r="<th><i class='fa' ng-class=\"{'fa-square-o':'unchecked'==isCheckedModel, 'fa-check-square-o':'checked'==isCheckedModel,  'fa-minus-square-o':'indeterminate'==isCheckedModel}\"  ng-click='clickThead()'></i></th>";angular.element(n.find("thead").children()[0]).prepend(r)}"undefined"!=typeof n.find("thead").children()[1]&&angular.element(n.find("thead").children()[1]).prepend("<th></th>"),a(n.find("table"))(e)}},this._addFooterPattern=function(e){n.find("table").prepend(e)},this._addRowPattern=function(t,r,i){if(this._checkEditableContent(t),this._addRepeatToRow(t,r,i),t.removeAttribute("ng-non-bindable"),n.find("table").append(t.outerHTML),this.bodyTemplate=t.innerHTML,"multiply"===e.select){var d="<td><i class='fa' ng-class=\"{'fa-square-o':'unchecked'==item.isCheckedModel,'fa-square-o ':undefined==item.isCheckedModel, 'fa-check-square-o':'checked'==item.isCheckedModel,  'fa-minus-square-o':'indeterminate'==item.isCheckedModel}\"></i></td>";angular.element(n.find("tbody").children()[0]).prepend(d)}a(n.find("tbody"))(e)},this._checkEditableContent=function(e){var t,n=/\{\{:*:*(.*?)\}\}/g;Array.prototype.forEach.call(e.querySelectorAll("[editable]"),function(e){t=e.innerHTML.replace(n,"$1"),e.innerHTML="<div contentEditable ng-model='"+t+"'>{{"+t+"}}</div>"})},this._addRepeatToRow=function(e,t,n){var r=angular.element(e).find("tr"),i=angular.element(r[0]);if(1==r.length)i.attr("ng-repeat","item in $filtered = (data"+t+")"+n),i.attr("ng-click")||i.attr("ng-click","setSelected(item, $index)"),i.attr("ng-class","{'selected-row':isSelected(item)}");else{var a=angular.element(r[1]);i.attr("ng-repeat-start","item in $filtered = (data"+t+")"+n),i.attr("ng-click")||i.attr("ng-click","setSelected(item, $index)"),i.attr("ng-class","{'selected-row':isSelected(item)}"),a.attr("ng-repeat-end","")}},e.$on("ngRepeatFinished",function(){}),e.isCheckedModel="unchecked",e.clickThead=function(){if("checked"==e.isCheckedModel?e.isCheckedModel="unchecked":"unchecked"==e.isCheckedModel?e.isCheckedModel="checked":"indeterminate"==e.isCheckedModel&&(e.isCheckedModel="checked"),c.toggleSelectAllFunc(),"true"==e.parentTable&&e.$broadcast("parentTableAllSelected",e.isCheckedModel),"true"==e.childTable){var t=n.find("table").parent().parent().parent().parent()[0].rowIndex;e.$emit("childTableAllSelected",t,e.isCheckedModel)}},this.toggleSelectAllFunc=function(){"checked"==e.isCheckedModel?(e.selectedModel=[],angular.forEach(e.$filtered,function(t){t.isCheckedModel="checked",e.selectedModel.push(t)})):(e.selectedModel=[],angular.forEach(e.$filtered,function(e){e.isCheckedModel="unchecked"})),angular.isFunction(e.setSelect)&&t(function(){e.setSelect()})},e.setSelected=function(n,r){"multiply"===e.select?c._containsInSelectArray(n)?e.selectedModel.splice(e.selectedModel.indexOf(n),1):e.selectedModel.push(n):e.selectedModel=n,c.clickTr(n,r),angular.isFunction(e.setSelect)&&t(function(){e.setSelect()})},this._containsInSelectArray=function(t){if(e.selectedModel.length)return e.selectedModel.filter(function(e){if("undefined"!=typeof e&&"undefined"!=typeof t)return e.$$hashKey==t.$$hashKey}).length>0},this.clickTr=function(t,r){if("checked"==t.isCheckedModel?t.isCheckedModel="unchecked":"unchecked"==t.isCheckedModel?t.isCheckedModel="checked":"indeterminate"==t.isCheckedModel?t.isCheckedModel="checked":void 0==t.isCheckedModel&&(t.isCheckedModel="checked"),1==c.isAllSelected()?e.isCheckedModel="checked":e.selectedModel.length>0&&e.selectedModel.length<e.$filtered.length?e.isCheckedModel="indeterminate":e.isCheckedModel="unchecked","true"==e.parentTable&&e.$broadcast("parentTableRowSelected",r,t.isCheckedModel),"true"==e.childTable){var i=n.find("table").parent().parent().parent().parent()[0].rowIndex;e.$emit("childTableRowSelected",i,e.isCheckedModel)}},this.isAllSelected=function(){return e.selectedModel.length===e.$filtered.length},e.isSelected=function(t){return!!e.selectedModel&&("multiply"===e.select?c._containsInSelectArray(t):t.$$hashKey==e.selectedModel.$$hashKey)},e.$on("parentTableRowSelected",function(t,r,i){"true"==e.childTable&&2*(r+1)==n.find("table").parent().parent().parent().parent()[0].rowIndex&&("checked"==i?e.isCheckedModel="checked":e.isCheckedModel="unchecked",c.toggleSelectAllFunc())}),e.$on("parentTableAllSelected",function(t,r){if("true"==e.childTable)for(var i=n.find("table").parent().parent().parent().parent().parent().children().length,a=0;a<i;a++)e.$broadcast("parentTableRowSelected",a,r)}),this.setParentRowStatus=function(n,r){"checked"==r?(n.isCheckedModel="checked","multiply"===e.select?c._containsInSelectArray(n)||e.selectedModel.push(n):e.selectedModel=n):"unchecked"==r?(n.isCheckedModel="unchecked","multiply"===e.select?c._containsInSelectArray(n)&&e.selectedModel.splice(e.selectedModel.indexOf(n),1):e.selectedModel=n):"indeterminate"==r&&(n.isCheckedModel="indeterminate","multiply"===e.select?c._containsInSelectArray(n)&&e.selectedModel.splice(e.selectedModel.indexOf(n),1):e.selectedModel=n),1==c.isAllSelected()?e.isCheckedModel="checked":e.selectedModel.length>0&&e.selectedModel.length<e.$filtered.length?e.isCheckedModel="indeterminate":e.isCheckedModel="unchecked",angular.isFunction(e.setSelect)&&t(function(){e.setSelect()})},e.$on("childTableRowSelected",function(t,n,r){"true"==e.parentTable&&c.setParentRowStatus(e.$filtered[n/2-1],r)}),e.$on("childTableAllSelected",function(t,n,r){"true"==e.parentTable&&e.setSelected(e.$filtered[n/2-1],n/2-1)}),e.curPage=1,e.jumpToPage=function(n){return"undefined"==typeof n?void swal.swal("请输入合适页码!"):(e.currentPage=n,void(angular.isFunction(e.reload)&&t(function(){e.reload()})))},e.pageChanged=function(){angular.isFunction(e.reload)&&t(function(){e.reload()})},e.itemsPerPageChanged=function(){angular.isFunction(e.reload)&&t(function(){e.reload()})},e.$watch("dynamicFields",function(t,r){if("true"==e.dynamicTable&&(e.dataIsLoading=!0,t!=r)){e.dataIsLoading=!1;var i=n.find("table");if(n.find("thead").remove(),n.find("tbody").remove(),e.dynamicHeaders.length>0){var d="<thead><tr>",c=l.getArrayFromParams(e.dynamicHeaders,"headers");angular.forEach(c,function(e,t){d+="<th>"+e,d+="</th>"}),d+="</tr></thead>",i.append(d)}if(e.dynamicFields.length>0){e.fields=l.getArrayFromParams(e.dynamicFields,"fields");var o='<tr ng-click="setSelected(item, $index)" ng-repeat="item in $filtered"  ng-class="{\'selected-row\':isSelected(item)}">';o+='<td ng-if="select===\'multiply\'"><input type="checkbox" ng-checked="isSelected(item)"></td>',o+='<td ng-if="!editable" ng-repeat="field in fields">{{item[field]}}</td>',o+='<td ng-if="editable" editable ng-repeat="field in fields">',o+='<div contenteditable ng-model="item[field]">{{item[field]}}</div>',o+="</td>",o+="</tr>",i.append(o)}a(n.find("table"))(e)}},!0)}]),angular.module("qsTable").directive("qsTable",["$compile","$interpolate",function(e,t){return{restrict:"A",replace:!0,templateUrl:"/src/templates/common.html",controller:"QsTableCtrl",controllerAs:"ctrl",transclude:!0,scope:{data:"=",currentPage:"=?",itemsPerPage:"=?",totalItems:"=?",resize:"=?",paging:"=?",fromUrl:"@",dynamicHeaders:"@headers",dynamicFields:"@fields",dynamicTable:"@",parentTable:"@",childTable:"@",setSelect:"&?",reload:"&?",sortingType:"@?sorting",editable:"&?",select:"@?",selectedModel:"=?",dragColumns:"=?",onEdit:"&?",onDrag:"&?"},compile:function(e,t){var n="",r="";if(t.addFilter&&(n+=t.addFilter),"false"!==t.sorting&&(n+="| orderBy:sortingArray"),t.dragColumns){e.find("th").attr("allow-drag","");var i=e.find("th");angular.forEach(i,function(e){e.hasAttribute("ng-if")&&e.removeAttribute("allow-drag")})}return"separate"===t.search?t.fields.split(",").forEach(function(e,t){n+="| filter:{'"+e.trim()+"':columnSearch['"+e.trim()+"']}"}):"undefined"!=typeof t.search&&"true"===t.search&&(n+="| filter:globalSearch"),r+=" | offset: currentPage:itemsPerPage |limitTo: itemsPerPage",e[0].querySelector("#rowTr").setAttribute("ng-repeat","item in $parent.$filtered = (data"+n+")"+r),e.find("paging").attr("count","$filtered.length"),function(e,t,i,a,d){a._init(),d(e,function(t,i){e.$owner=i.$parent;for(var d in t)if(t.hasOwnProperty(d))switch(t[d].tagName){case"THEAD":e.findHead=!0,a._addHeaderPattern(t[d]);break;case"TBODY":e.findBody=!0,a._addRowPattern(t[d],n,r);break;case"TFOOT":a._addFooterPattern(t[d])}})}}}}]),angular.module("qsTable").filter("offset",function(){return function(e,t,n){if(e){t=parseInt(t,10),n=parseInt(n,10);var r=(t-1)*n;return e.slice(r,r+n)}}}),angular.module("qsTable").controller("QsTableResizeCtrl",["$scope",function(e){function t(e){a&&(n.width=i+(e.pageX-r))}var n,r,i,a=!1,d=!1;e.resizeStart=function(e){var d=e.target?e.target:e.srcElement;d.classList.contains("resize")&&(n=d.parentNode,a=!0,r=e.pageX,i=d.parentNode.offsetWidth,document.addEventListener("mousemove",t),e.stopPropagation(),e.preventDefault())},e.resizeEnd=function(e){a&&(document.removeEventListener("mousemove",t),e.stopPropagation(),e.preventDefault(),a=!1,d=!0)},e.getResizePressEnd=function(){return d},e.setResizePressEnd=function(e){d=e}}]),angular.module("qsTable").controller("QsTableSortingCtrl",["$scope",function(e){e.sort={fields:[],reverse:[]},e.sortingArray=[],e.sortBy=function(t){if(e.getResizePressEnd())return void e.setResizePressEnd(!1);if(e.data.length){var n=e.headers[e.fields.indexOf(t)];"compound"==e.sortingType?e.sort.fields.indexOf(n)==-1?(e.sort.fields.push(n),e.sortingArray.push(t),e.sort.reverse.push(!1)):e.changeReversing(t,e.sort.fields.indexOf(n)):"simple"==e.sortingType&&(e.sort.fields=[n],e.changeReversing(t))}},e.changeReversing=function(t,n){"compound"==e.sortingType?(e.sort.reverse[n]=!e.sort.reverse[n],e.sortingArray[n]=e.sort.reverse[n]?"-"+t:t):"simple"==e.sortingType&&(e.sort.reverse[0]=!e.sort.reverse[0],e.sortingArray=e.sort.reverse[0]?[t]:["-"+t])},e.headerIsSortedClass=function(t){if(e.sortingArray.length)if("simple"==e.sortingType){if(t==e.sort.fields[0]||"-"+t==e.sort.fields[0])return e.sort.reverse[0]?"table-sort-down":"table-sort-up"}else if("compound"==e.sortingType){var n=e.sort.fields.indexOf(t);if(n!=-1)return e.sort.reverse[n]?"table-sort-down":"table-sort-up"}},e.removeSorting=function(){var t=e.sort.fields.indexOf(this.sortField);t>-1&&(e.sort.fields.splice(t,1),e.sort.reverse.splice(t,1),e.sortingArray.splice(t,1)),t=null}}]),angular.module("qsTable").service("QsTableUtilService",[function(){return Array.prototype.swap=function(e,t){if(e>=this.length)for(var n=e-this.length;n--+1;)this.push(void 0);return this.splice(e,0,this.splice(t,1)[0]),this},{getArrayFromParams:function(e,t){if(!e)throw"Required '"+t+"' attribute is not found!";for(var n=[],r=e.split(","),i=0,a=r.length;i<a;i++)n.push(r[i].trim());return n}}}]);
angular.module("qsTable").run(["$templateCache", function($templateCache) {$templateCache.put("/src/templates/common.html","<div class=\"qs-table-module\"><div class=\"col-xs-12 col-sm-6 col-md-8 sorting-container\"><div ng-if=\"sortingType && sort.fields.length\">Sorting:<div ng-repeat=\"sortField in sort.fields\" class=\"sorting-badge\"><span class=\"glyphicon\" ng-class=\"{\'glyphicon-chevron-down\':sort.reverse[$index], \'glyphicon-chevron-up\':!sort.reverse[$index]}\"></span> {{::sortField}} <span class=\"glyphicon glyphicon-remove close\" ng-click=\"removeSorting()\"></span></div></div></div><div class=\"form-group col-xs-12 col-sm-6 col-md-4\" ng-if=\"search && \'separate\'!=search\"><input type=\"text\" placeholder=\"Search\" ng-model=\"$parent.globalSearch\" class=\"row pull-right form-control search\" ng-model-options=\"{ updateOn: \'default blur\', debounce: { \'default\': 500, \'blur\': 0 } }\" ng-change=\"setCurrentPageForPageCtrl(0)\"> <i class=\"glyphicon glyphicon-search search_icon\"></i></div><div class=\"clearfix\"></div><div class=\"back-cover\"><table class=\"table table-responsive table-bordered qs-table\" ng-mousedown=\"resizeStart($event)\" ng-mouseup=\"resizeEnd($event)\"><thead ng-if=\"!customHeader\"><tr><th ng-repeat=\"head in headers track by $index\" ng-click=\"sortBy(fields[$index])\" ng-class=\"headerIsSortedClass(head)\" class=\"sortable\">{{head}}<div ng-if=\"resize\" class=\"resize\"></div></th></tr></thead><thead ng-if=\"!customHeader&& \'separate\'===search\"><tr><th ng-repeat=\"head in headers track by $index\" class=\"separate\"><i class=\"glyphicon glyphicon-search search_icon separate\"></i> <input type=\"text\" ng-model=\"columnSearch[fields[$index]]\" placeholder=\"{{head}}...\" class=\"form-control search separate\" ng-model-options=\"{ updateOn: \'default blur\', debounce: { \'default\': 500, \'blur\': 0 } }\" ng-change=\"setCurrentPageForPageCtrl(0)\"></th></tr></thead><tbody ng-if=\"!findBody\"><tr id=\"rowTr\" ng-click=\"setSelected(item)\" ng-class=\"{\'selected-row\':ifSelected(item)}\"><!-- <= will inject ng-repeat --><!-- params: headers and fields --><td ng-if=\"!editable\" ng-repeat=\"field in fields\">{{item[field]}}</td><td ng-if=\"editable\" editable ng-repeat=\"field in fields\"><div contenteditable ng-model=\"item[field]\">{{item[field]}}</div></td></tr></tbody></table></div><div class=\"loading\" ng-show=\"dataIsLoading\"><span class=\"glyphicon glyphicon-refresh glyphicon-refresh-animate\"></span> Loading Data...</div><paging ng-if=\"paging\" data-display=\"display\" count=\"$filtered.length\" class=\"qs-table-paging\" ng-hide=\"dataIsLoading\"></paging><div class=\"clearfix\"></div></div>");}]);